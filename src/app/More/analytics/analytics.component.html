<div class="div-filters">
    <mat-form-field appearance="outline">
        <mat-label>Insira um intervalo de datas</mat-label>
        <mat-date-range-input [formGroup]="range" [rangePicker]="picker">
            <input matStartDate formControlName="start" placeholder="Start date">
            <input matEndDate formControlName="end" placeholder="End date" (dateChange)="loadAll()">
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>

        @if (range.controls.start.hasError('matStartDateInvalid')) {
        <mat-error>Invalid start date</mat-error>
        }
        @if (range.controls.end.hasError('matEndDateInvalid')) {
        <mat-error>Invalid end date</mat-error>
        }
    </mat-form-field>
    <mat-form-field [hidden]="cryptos.length == 0" appearance="outline">
        <mat-label>Moedas</mat-label>
        <mat-select [(ngModel)]="selectedCrypto" matNativeControl (selectionChange)="loadAll()">
            <mat-option>Limpar</mat-option>
            <mat-option *ngFor="let crypto of cryptos" [value]="crypto.symbol">
                <img src="../../../assets/Cryptos/{{ crypto.symbol }}.png" width="17px" />
                &nbsp;{{ crypto.symbol }} - {{ crypto.name }}
            </mat-option>
        </mat-select>
    </mat-form-field>
    <mat-form-field appearance="outline">
        <mat-label>Vl. máximo de negociação</mat-label>
        <input matInput type="number" [(ngModel)]="maxNegotiationValue" min="0" required>
        @if (maxNegotiationValue == null) {
        <mat-error>Informe um valor</mat-error>
        }
    </mat-form-field>
    <br>
</div>
<button mat-flat-button color="primary" (click)="loadAll()"
    [disabled]="maxNegotiationValue == null || loadingOpportunities">Consultar</button>

<mat-tab-group>
    <mat-tab label="Gráficos">
        <div class="div-graphics">
            <h1>ATIVOS</h1>
            <div class="div-analytics">
                <mat-card class="div-analytics mat-elevation-z8" appearance="outlined">
                    <mat-card-header>
                        <mat-card-title>TOP ATIVOS COM MAIS ARBITRAGENS
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <ngx-charts-advanced-pie-chart [view]="viewCryptos" scheme="picnic" [results]="pieChartCryptos"
                            style="fill: white;" [percentageFormatting]="formatValue" [animations]="false">
                        </ngx-charts-advanced-pie-chart>
                    </mat-card-content>
                </mat-card>
                <mat-card class="div-analytics mat-elevation-z8" appearance="outlined">
                    <mat-card-header>
                        <mat-card-title>TOP ATIVOS MAIS LUCRATIVOS
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <ngx-charts-advanced-pie-chart [view]="viewCryptos" scheme="picnic" [results]="pieChartsValues"
                            style="fill: white;" [valueFormatting]="formatValueToBRL"
                            [percentageFormatting]="formatValue" [animations]="false">
                        </ngx-charts-advanced-pie-chart>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
        <hr>
        <div class="div-graphics">
            <h1>CORRETORAS</h1>
            <div class="div-analytics-exchanges" *ngIf="opportunities.length > 0 && !loadingOpportunities">
                <mat-card class="div-analytic mat-elevation-z8" appearance="outlined"
                    [hidden]="opportunities.length == 0 || noneOpportunity">
                    <mat-card-header>
                        <mat-card-title>TOP CORRETORA DE
                            COMPRAS</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <ngx-charts-bar-horizontal label="Total" [view]="viewExchanges" scheme="picnic"
                            [results]="pieChartsExchangesToBuy" [dataLabelFormatting]="formatValueToBRL"
                            [gradient]="false" [xAxis]="true" [yAxis]="true" style="fill: white;">
                        </ngx-charts-bar-horizontal>
                    </mat-card-content>
                </mat-card>
                <mat-card class="div-analytic mat-elevation-z8" appearance="outlined"
                    [hidden]="opportunities.length == 0">
                    <mat-card-header>
                        <mat-card-title>TOP CORRETORAS DE
                            VENDA</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <ngx-charts-bar-horizontal label="Total" [view]="viewExchanges" scheme="picnic"
                            [results]="pieChartsExchangesToSell" [dataLabelFormatting]="formatValueToBRL"
                            [gradient]="false" [xAxis]="true" [yAxis]="true" style="fill: white;">
                        </ngx-charts-bar-horizontal>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </mat-tab>
    <mat-tab label="Arbitragens">

        <div>
            <table mat-table [dataSource]="dsOpportunities" multiTemplateDataRows class="mat-elevation-z8">
                <ng-container matColumnDef="position">
                    <th mat-header-cell *matHeaderCellDef></th>
                    <td mat-cell *matCellDef="let opportunity">
                        <img src="../../../assets/Cryptos/{{ opportunity.symbol }}.png" width="30px"
                            style="border-radius: 50%" />
                    </td>
                </ng-container>

                <ng-container matColumnDef="symbol">
                    <th mat-header-cell *matHeaderCellDef>Moeda</th>
                    <td mat-cell *matCellDef="let opportunity">
                        {{ opportunity.symbol }} - {{ opportunity.name }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Tempo Ativo</th>
                    <td mat-cell *matCellDef="let opportunity">
                        {{ opportunity.minutes }} minutos
                    </td>
                </ng-container>

                <ng-container matColumnDef="valueToBuy">
                    <th mat-header-cell *matHeaderCellDef style="text-align: center">
                        Vl. Compra
                    </th>
                    <td mat-cell *matCellDef="let opportunity" style="color: greenyellow; text-align: center">
                        {{
                        (opportunity.valueToBuy | currency : "BRL" : "symbol" : "1.4-4")
                        }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="valueToSell">
                    <th mat-header-cell *matHeaderCellDef style="text-align: center">
                        Vl. Venda
                    </th>
                    <td mat-cell *matCellDef="let opportunity" style="color: red; text-align: center">
                        {{(opportunity.valueToSell
                        | currency : "BRL" : "symbol" : "1.4-4")
                        }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="differencePercentage">
                    <th mat-header-cell *matHeaderCellDef style="text-align: center">
                        Spread
                    </th>
                    <td mat-cell *matCellDef="let opportunity" [ngClass]="{
                    'high-percentage': opportunity.differencePercentage > 9,
                    'mid-percentage':
                      opportunity.differencePercentage >= 5 &&
                      opportunity.differencePercentage <= 9,
                    'low-percentage': opportunity.differencePercentage < 5
                  }" style="text-align: center">
                        <b>{{
                            opportunity.differencePercentage / 100 | percent : "1.2-2"
                            }}</b>
                    </td>
                </ng-container>

                <ng-container matColumnDef="totalCanNegociate">
                    <th mat-header-cell *matHeaderCellDef>
                        Total Negoc.
                    </th>
                    <td mat-cell *matCellDef="let opportunity">
                        {{(opportunity.totalCanNegociate
                        | currency : "BRL" : "symbol" : "1.4-4")
                        }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="totalProfit">
                    <th mat-header-cell *matHeaderCellDef>
                        Total Ganhos.
                    </th>
                    <td mat-cell *matCellDef="let opportunity">
                        {{(opportunity.totalProfit - opportunity.totalCanNegociate
                        | currency : "BRL" : "symbol" : "1.4-4")
                        }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="withdrawFee">
                    <th mat-header-cell *matHeaderCellDef>
                        Tax. de Saque
                    </th>
                    <td mat-cell *matCellDef="let opportunity" style="color: yellow; white-space: pre-line;">
                        {{ opportunity.withdrawFee != -1 ? (opportunity.withdrawFee | currency : "BRL" : "symbol" :
                        "1.2-2") :
                        ''}}
                    </td>
                </ng-container>

                <ng-container matColumnDef="fee">
                    <th mat-header-cell *matHeaderCellDef style="text-align: center">
                        Taxa de Negoc.
                    </th>
                    <td mat-cell *matCellDef="let opportunity" style="color: yellow; text-align: center">
                        {{ opportunity.fee / 100 | percent : "1.2-2" }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="exchangeToBuy">
                    <th mat-header-cell *matHeaderCellDef style="text-align: center">
                        Corretora Compra
                    </th>
                    <td mat-cell *matCellDef="let opportunity" style="text-align: center">
                        <a href="{{ opportunity.exchangeToBuyUrl }}" target="_blank">
                            <img src="../../../assets/Exchanges/{{
                        opportunity.exchangeToBuyName
                      }}.svg" width="30px" matTooltip="{{ opportunity.exchangeToBuyName }}"
                                matTooltipPosition="below" />
                        </a>
                    </td>
                </ng-container>

                <ng-container matColumnDef="exchangeToSell">
                    <th mat-header-cell *matHeaderCellDef style="text-align: center">
                        Corretora Venda
                    </th>
                    <td mat-cell *matCellDef="let opportunity" style="text-align: center">
                        <a href="{{ opportunity.exchangeToSellUrl }}" target="_blank">
                            <img src="../../../assets/Exchanges/{{
                        opportunity.exchangeToSellName
                      }}.svg" width="30px" matTooltip="{{ opportunity.exchangeToSellName }}"
                                matTooltipPosition="below" />
                        </a>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let opportunity; columns: displayedColumns"></tr>
            </table>
        </div>
        <mat-paginator [length]="opportunities.length" [showFirstLastButtons]="true" [pageSize]="10"
            showFirstLastpnl-buttons #opportunitiesPaginator></mat-paginator>

    </mat-tab>
</mat-tab-group>

<div *ngIf="!loadingOpportunities" class="div-center">
    <h2>Sem Oportunidades</h2>
</div>
<div *ngIf="loadingOpportunities" class="div-center">
    <app-loading></app-loading>
</div>